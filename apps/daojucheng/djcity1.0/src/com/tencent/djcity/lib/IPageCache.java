package com.tencent.djcity.lib;

import java.io.ByteArrayInputStream;
import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.io.Serializable;
import java.util.HashMap;

import android.content.ContentValues;

import com.tencent.djcity.util.Base64;
import com.tencent.djcity.util.Log;
import com.tencent.djcity.util.ToolUtil;
import com.tencent.djcity.util.db.Database;
import com.tencent.djcity.util.db.DbFactory;

/**t_cache_pageè¡¨ç?????
 * t_page_cache(
 * 				id              varchar(50) primary key comment 'ä¸»é??', 
 * 				content         TEXT comment 'å­???¨ç?????å®¹ï??ä¸»è???????°æ?? ??¨å??', 
 * 				row_create_time INTEGER comment 'è®°å????????å»ºæ?¶é??', 
 * 				row_expire_time INTEGER  comment 'è¿?????????¶é??'
 * 			   )
 * è¯¥ç±»ä¸»è??å®????äº?ä»?t_page_cacheè¡¨æ?¥å????°è¡¨ä¸????ä¸?è®°å???????°æ??ï¼?ä»¥å??å¯?content???è®°å?????åº?????????????åº??????????è¿?ç¨????
 */
public class IPageCache {

	private static final String LOG_TAG =  IPageCache.class.getName();

	private static final String TABLE = "t_page_cache";

	private Database db;

	public IPageCache(DbFactory.DbType target) {
		db = DbFactory.getInstance(target);
	}

	public IPageCache() {
		db = DbFactory.getInstance(DbFactory.DbType.INNER);
	}
	
	/**
	 * å°?å¯¹è±¡åº???????ï¼???¶å????????ä¸?ä¸?å­?ç¬?ç±»å??ï¼?è°???¨è?¥ç±»???set()??½æ?°æ?¥å?????å¯¹è?¥å?¹è±¡????????¥æ???????´æ??
	 * @param key:å¯¹è±¡å­???¨æ?°æ??åº?ä¸??????????
	 * @param objï¼?å¾?åº??????????å¯¹è±¡
	 * @param cacheTime
	 * @return å¯¹è±¡åº???????ä¹?????????????å­?ç¬?ä¸?
	 */
	public boolean setObject(String key, Object obj, long cacheTime) {

		String str = null;
		ByteArrayOutputStream baops = null;
		ObjectOutputStream oos = null;

		try {
			baops = new ByteArrayOutputStream();
			oos = new ObjectOutputStream(baops);
			oos.writeObject(obj);
			str = Base64.encodeToString(baops.toByteArray(), false);
		} catch (IOException e) {
			Log.e(LOG_TAG, "set|" + ToolUtil.getStackTraceString(e));
			return false;
		} finally {
			try {
				if (oos != null) {
					oos.close();
				}
				if (baops != null) {
					baops.close();
				}
			} catch (IOException ex) {
				Log.e(LOG_TAG, "setObject|" + ToolUtil.getStackTraceString(ex));
				return false;
			}
		}

		return set(key, str, cacheTime);
	}

	/**
	 * å°?ä¼???¥ç??å­?ç¬?ä¸²å?¹è±¡???å¯¹å?????ä¸»é??å­???¥æ?°æ??åº?ä¸?ï¼?å¦????è¯?keyå·²ç??å­???¨é?£ä??å°±æ?´æ?°å?¹å?????è®°å??ï¼?å¦????keyä¸?å­???¨é?£ä??å°±å??è¯¥è?°å???????¥å?°æ?°æ??åº?ä¸????
	 * @param keyï¼?å¾??????¥å??ç¬?ä¸²ç??ä¸»é??
	 * @param contentï¼?å¾??????¥ç??å­?ç¬?ä¸?
	 * @param cacheTime
	 * @return å¦?????????¥æ????¥æ???????´æ?°æ???????£ä??å°±è?????trueï¼???????è¿????false
	 */
	public boolean set(String key, String content, long cacheTime) {

		if (null == db)
			return false;

		String id = db.getValue("select id from " + TABLE + " where id = ?", key);
		if (db.errCode != 0) {
			return false;
		}

		int affectRows = 0;

		long now = ToolUtil.getCurrentTime();
		long end = cacheTime == 0 ? 0 : (now + cacheTime * 1000);

		ContentValues param = new ContentValues();

		param.put("content", content);
		param.put("row_create_time", now);
		param.put("row_expire_time", end);

		if (null != id) {
			affectRows = db.update(TABLE, param, "id=?", key);
		} else {
			param.put("id", key);
			affectRows = (int) db.insert(TABLE, param);
		}

		return affectRows > 0;
	}

	/**
	 * ä¸»è???????¹æ??ä¸»é????¥ä????°æ??åº?ä¸?å¾????contentï¼???¶å?????åº??????????å¯¹å?????å¯¹è±¡???
	 * @param keyï¼???°æ??åº?ä¸?è®°å?????ä¸»é??
	 * @param whichClass :???åº???????å¯¹è±¡???ç±»å??
	 * @return ??¹æ??å­?ç¬?ä¸²å??åº????????????????å¯¹è±¡
	 */
	@SuppressWarnings("unchecked")
	public <T extends Serializable> T getObject(String key, Class<T> whichClass) {
		String body = get(key);

		if ( null == body) {
			return null;
		}

		ObjectInputStream ois = null;
		T obj = null;
		try {
		
			ois = new ObjectInputStream(new ByteArrayInputStream(Base64.decode(body)));
			obj = (T) ois.readObject();
			
		} catch (Exception e) {
			Log.e(LOG_TAG, ToolUtil.getStackTraceString(e));
			return null;
		} finally {
			try {
				if (ois != null){
					ois.close();
				}
			} catch (IOException e) {
				Log.e(LOG_TAG, ToolUtil.getStackTraceString(e));
			}
		}
		return obj;
	}

	/**
	 * ??¹æ??è®°å?????ä¸»é??ä»???°æ??åº?ä¸?å¾???°è?°å?????content???å®¹ï????¤æ????°æ????????è¿????ï¼?å¦????å·²ç??è¿????å°±å????¤æ??,è¯¥å?½æ?°å?¶å??åº?è¯¥å?½å??ä¸?getContent()??´å¥½
	 * @param keyï¼?è®°å?????ä¸»é??
	 * @return å­?ç¬?ä¸²ç±»??????content???å®?
	 */ 
	public String get(String key) {
		HashMap<String, String> result = db.getOneRow("select content, row_expire_time from " + TABLE + " where id = ?", key);

		if (0 != db.errCode) {
			return null;
		}

		if (null == result) {
			return null;
		}

		long now = ToolUtil.getCurrentTime();
		long expire = Long.valueOf(result.get("row_expire_time"));
		if (expire != 0 && expire < now) {
			db.execute("delete from " + TABLE + " where id = ?", key);
			return null;
		}

		return result.get("content");

	}
	
	/**
	 * ??¹æ??ä¼???¥ç??ä¸»é??ï¼???·å??row_create_time??????ä¿¡æ??
	 * @param keyï¼?ä¼???¥ç??ä¸»é??
	 * @return	row_create_time??????ä¿¡æ??
	 */
	public long getRowCreateTime(String key) {
		HashMap<String, String> pResult = db.getOneRow("select row_create_time from " + TABLE + " where id = ?", key);
		long pNow = ToolUtil.getCurrentTime();
		
		if (0 != db.errCode || null == pResult) {
			return pNow;
		}
		
		long pCreateTime = Long.valueOf(pResult.get("row_create_time"));
		
		return pCreateTime;
	}
	
	/**
	 * ??¹æ??ä¸»é????¥å?????content???å®¹ï??ä¸???¤æ?????å®¹æ?????è¿????ï¼?æ³¨æ??è¿?ä¸???½æ?°å??è¯¥ç±»???get()??½æ?°ç????ºå?????
	 * @param key è®°å?????ä¸»é??
	 * @return è®°å?????content???å®?
	 */
	public String getNoDelete(String key) {
		HashMap<String, String> result = db.getOneRow("select content from " + TABLE + " where id = ?", key);

		if (0 != db.errCode) {
			return null;
		}

		if (null == result) {
			return null;
		}

		return result.get("content");
	}
	
	/*
	 * judge whether content of the key is expired or not
	 * @param key
	 */
	public boolean isExpire(String key) {
		HashMap<String, String> result = db.getOneRow("select row_expire_time from " + TABLE + " where id = ?", key);

		if (0 != db.errCode) {
			return true;
		}

		if (null == result) {
			return true;
		}
		
		long now = ToolUtil.getCurrentTime();
		long expire = Long.valueOf(result.get("row_expire_time"));
		if (expire != 0 && expire < now) {
			return true;
		}
		
		return false;
	}

	public void remove(String key) {
		db.execute("delete from " + TABLE + " where id = ?", key);
	}
	
	public void removeLeftLike(String key) {
		db.execute("delete from " + TABLE + " where id like ?", key + "%");
	}
}
