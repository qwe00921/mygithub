package com.tencent.djcity.util.db;

import java.util.Date;

import android.database.sqlite.SQLiteDatabase;

import com.tencent.djcity.util.Config;
import com.tencent.djcity.util.Log;
import com.tencent.djcity.util.ToolUtil;
import com.tencent.djcity.util.cache.SDCache;

public class DbCard extends Database{
	
	private static final String LOG_TAG =  DbCard.class.getName();
	
	private static boolean HAVECHECKED = false;
	
	/**
	 * é¦????å¾???°æ?°æ??åº????å­???¨è·¯å¾?ï¼?æ£???¥æ?°æ??åº???????å­????ï¼?å¦????å­???¨é?£ä??å°±è?????checkUpdate()??½æ?°æ????¥æ?°æ??åº??????????ï¼?å¦????ä¸?å­???¨é?£ä??å°±è?????onCreate()??½æ?°é????°å??å»?
	 */
	public void init(){
		if( null != core &&  core.isOpen() ){
			return;
		}
		
		SDCache storage = new SDCache();
		String path = storage.getTempPath();//è¿???????å°±æ??getRootPath();
		
		if( null == path ){
			Log.e(LOG_TAG, "init|getTempPath failed");
			
			return;
		}
		
		boolean exists = storage.fileExsits( Config.SD_DATABASE_NAME );
		
		core = SQLiteDatabase.openOrCreateDatabase( path + Config.SD_DATABASE_NAME, null);
		
		if( exists ){
			checkUpdate();
		}
		else{
			onCreate( );
		}
	}
	/**
	 * ???å»ºæ?°æ??åº??????¢ç??è¡?ï¼?å¹¶æ????¥å??å§???°æ?????
	 */
	private void onCreate() {
		try{
			long now = new Date().getTime();
			long exipre = now + 3600 * 1000 * 24 * 365 * 10;
			core.execSQL("create table ifnot exists page_cache(id varchar(50) primary key, content TEXT, row_create_time INTEGER, row_expire_time INTEGER)");
			core.execSQL("insert into page_cache(id, content, row_create_time, row_expire_time) values(?,?,?,?)", new String[]{Config.SD_DATABASE_VERSION_NAME, String.valueOf( Config.SD_DATABASE_VERSION ), String.valueOf( now ), String.valueOf( exipre ) } );
		}catch(Exception ex){
			Log.e(LOG_TAG, "onCreate|page_cache|" + ToolUtil.getStackTraceString(ex));;
		};
		
	}
	/**
	 *æ£???¥å???????°æ??åº?????????????ç³»ç??ä¿?å­????????????????ä¸???´ï??å¦??????????ä¸ºç©ºï¼?è®°å?????è¯???¥å??ï¼?å¦??????????ä¸?ä¸???´é?£ä??è°????onUpadte()??½æ?°ï??å®??????°æ??åº??????¢è¡¨??????å»ºã??
	 */
	private void checkUpdate() {
		
		if( HAVECHECKED)	return;
		
		HAVECHECKED = true;
		
		String version = getValue("select content from page_cache where id = ?",  new String[]{ Config.SD_DATABASE_VERSION_NAME });
		
		if( null == version ){
			Log.e(LOG_TAG, "checkUpdate|value is empty" + errMsg);
			return;
		}
		
		if( Integer.valueOf(version) != Config.SD_DATABASE_VERSION ){
			onUpdate();
		}
		
	}
	
	/**
	 * ?????¤æ????????ä¸?ä¸???´ç????°æ??åº??????¢æ????????è¡?ï¼?è°????onCreate()??½æ?°ï??å®??????°æ??åº?????????°å??å»ºã??
	 */
	private void onUpdate() {
		try{
			core.execSQL("DROP TABLE IF EXISTS page_cache");
		}catch(Exception ex){
			Log.e(LOG_TAG, "onUpgrade|page_cache|" + ToolUtil.getStackTraceString(ex));;
		};
		
		onCreate();
	}
		
}
